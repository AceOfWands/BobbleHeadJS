/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = "./src/bobblehead.js");
/******/ })
/************************************************************************/
/******/ ({

/***/ "./src/bobblehead.js":
/*!***************************!*\
  !*** ./src/bobblehead.js ***!
  \***************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("\r\n\r\nwindow.bobblehead = (function(a){\r\n\ta.BobbleHead = {\r\n\t\tUserPool: class{\r\n\t\t\tstatic getUser(username){\r\n\t\t\t\treturn BobbleHead.UserPool.users[username];\r\n\t\t\t}\r\n\t\t\tstatic addUser(user){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tBobbleHead.UserPool.users[user.username] = user;\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tUser: class{\r\n\t\t\tconstructor(username,password,roles){\r\n\t\t\t\tthis.username = username;\r\n\t\t\t\tthis.password = password;\r\n\t\t\t\tthis.roles = roles\r\n\t\t\t}\r\n\t\t\tgetRoles(){\r\n\t\t\t\treturn this.roles;\r\n\t\t\t}\r\n\t\t\thasRole(role){\r\n\t\t\t\treturn this.roles.indexOf(role) != -1;\r\n\t\t\t}\r\n\t\t\tgiveRole(role){\r\n\t\t\t\tthis.roles.push(role);\r\n\t\t\t}\r\n\t\t},\r\n\t\tRole: class{\r\n\t\t\tconstructor(name){\r\n\t\t\t\tthis.name;\r\n\t\t\t}\r\n\t\t},\r\n\t\tRolePool: class{\r\n\t\t\tstatic getRole(name){\r\n\t\t\t\tif(!BobbleHead.RolePool.roles[name])\r\n\t\t\t\t\tBobbleHead.RolePool.roles[name] = new BobbleHead.Role(name);\r\n\t\t\t\treturn BobbleHead.RolePool.roles[name];\r\n\t\t\t}\r\n\t\t},\r\n\t\tSession: class{\r\n\t\t\tconstructor(info = null){\r\n\t\t\t\tthis.info = info;\r\n\t\t\t}\r\n\t\t\tgetInfo(){\r\n\t\t\t\treturn this.info;\r\n\t\t\t}\r\n\t\t},\r\n\t\tResponse: class{\r\n\t\t\tconstructor(code,status,content){\r\n\t\t\t\tthis.code = code;\r\n\t\t\t\tthis.status = status;\r\n\t\t\t\tthis.content = content;\r\n\t\t\t}\r\n\t\t},\r\n\t\tRequest: class{\r\n\t\t\tconstructor(method,uri,data,headers = {}){\r\n\t\t\t\tthis.method = method;\r\n\t\t\t\tthis.uri = uri;\r\n\t\t\t\tif(data != null)\r\n\t\t\t\t\tthis.setData(data)\r\n\t\t\t\telse\r\n\t\t\t\t\tthis.data = null;\r\n\t\t\t\tthis.headers = headers;\t\t\t\r\n\t\t\t}\r\n\t\t\tsetHeader(a,b = null){\r\n\t\t\t\tif(this.headers==null)\r\n\t\t\t\t\tthis.headers = {};\r\n\t\t\t\tthis.headers[a] = b;\r\n\t\t\t}\r\n\t\t\tgetData(){\r\n\t\t\t\treturn this.data;\r\n\t\t\t}\r\n\t\t\tgetMethod(){\r\n\t\t\t\treturn this.method;\r\n\t\t\t}\r\n\t\t\tgetUri(){\r\n\t\t\t\treturn this.uri;\r\n\t\t\t}\r\n\t\t\t*getHeaders(){\r\n\t\t\t\tfor(var x in this.headers){\r\n\t\t\t\t\tvar v = this.headers[x];\r\n\t\t\t\t\tyield {'name':x,'value':v};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tGenericConfiguration: class{\r\n\t\t\tconstructor(properties = {}){\r\n\t\t\t\tthis.properties = properties || {};\r\n\t\t\t}\r\n\t\t\t*getProperties(){\r\n\t\t\t\tfor(var x in this.properties){\r\n\t\t\t\t\tvar v = this.properties[x];\r\n\t\t\t\t\tyield {x,v};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tgetProperty(name){\r\n\t\t\t\treturn this.properties[name] || null;\r\n\t\t\t}\r\n\t\t},\r\n\t\tModel: class{\r\n\t\t\tconstructor(name){\r\n\t\t\t\tthis.name = name;\r\n\t\t\t}\r\n\t\t\tget(proprietes){}\r\n\t\t\tupdate(instance){}\r\n\t\t\tsave(instance){}\r\n\t\t\tdestroy(instance){}\r\n\t\t},\r\n\t\tModelInstance: class{\r\n\t\t\tconstructor(id, model, change = null, allowEdit = true){\r\n\t\t\t\tthis.id = id;\r\n\t\t\t\tthis.model = model;\r\n\t\t\t\tthis.change = (change != null) ? change.bind(this) : null;\r\n\t\t\t\tthis.allowEdit = allowEdit;\r\n\t\t\t}\r\n\t\t},\r\n\t\tModelPool: class{\r\n\t\t\tstatic getModels(){\r\n\t\t\t\treturn BobbleHead.ModelPool.models;\r\n\t\t\t}\r\n\t\t\tstatic getModel(name){\r\n\t\t\t\treturn BobbleHead.ModelPool.models[name];\r\n\t\t\t}\r\n\t\t\tstatic addModel(model){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tBobbleHead.ModelPool.models[model.name] = model;\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tRoute: class{\r\n\t\t\tconstructor(uri1, uri2){\r\n\t\t\t\tif(uri1.startsWith('app://') && uri2.startsWith('app://')){\r\n\t\t\t\t\tvar argMap = {};\r\n\t\t\t\t\tvar count = {i: 0};\r\n\t\t\t\t\tthis.uri1 = new RegExp(\"^\" + uri1.replace(/:[^\\s/]+/g, function(count, _match){\r\n\t\t\t\t\t\tcount.i += 1;\r\n\t\t\t\t\t\tthis[_match.substring(1)] = count.i;\r\n\t\t\t\t\t\treturn '([\\\\w-]+)';\r\n\t\t\t\t\t}.bind(argMap, count)) + \"$\");\r\n\t\t\t\t\tthis.uri2 = uri2.replace(/:[^\\s/]+/g, function(_match){\r\n\t\t\t\t\t\tvar indx = this[_match.substring(1)];\r\n\t\t\t\t\t\tif(indx)\r\n\t\t\t\t\t\t\treturn '$'+ indx;\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\treturn _match;\r\n\t\t\t\t\t}.bind(argMap));\r\n\t\t\t\t}else\r\n\t\t\t\t\tthrow new BobbleHead.Exceptions.InvalidRouteException();\r\n\t\t\t}\r\n\t\t\tmatch(uri){\r\n\t\t\t\treturn this.uri1.test(uri);\r\n\t\t\t}\r\n\t\t\troute(uri){\r\n\t\t\t\tif(!this.match(uri)) return null;\r\n\t\t\t\treturn uri.replace(this.uri1,this.uri2);\r\n\t\t\t}\r\n\t\t},\r\n\t\tRouter: class{\r\n\t\t\tstatic route(uri){\r\n\t\t\t\tvar r = BobbleHead.Router.routes;\r\n\t\t\t\tfor(var i=0; i<r.length; i++){\r\n\t\t\t\t\tvar t = r[i].route(uri);\r\n\t\t\t\t\tif(t) return t;\r\n\t\t\t\t}\r\n\t\t\t\treturn uri;\r\n\t\t\t}\r\n\t\t\tstatic addRoute(route){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tBobbleHead.Router.routes.push(route);\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tPage: class{\r\n\t\t\tconstructor(path,vid,lock,configuration = null, modules = null, keepLive = false, allowDuplicate = false, ghostPage = false, roles = null){\r\n\t\t\t\tthis.path = path;\r\n\t\t\t\tthis.vid = vid;\r\n\t\t\t\tthis.lock = lock;\r\n\t\t\t\tthis.configuration = configuration;\r\n\t\t\t\tthis.modules = modules;\r\n\t\t\t\tthis.roles = roles;\r\n\t\t\t\tthis.keepLive = keepLive;\r\n\t\t\t\tthis.allowDuplicate = allowDuplicate;\r\n\t\t\t\tthis.ghostPage = ghostPage;\r\n\t\t\t}\r\n\t\t},\r\n\t\tPageContext: class{\r\n\t\t\tconstructor(domcontainer){\r\n\t\t\t\tvar globalContext = BobbleHead.Context.getGlobal();\r\n\t\t\t\tfor(var x in globalContext){\r\n\t\t\t\t\tthis[x] = globalContext[x];\r\n\t\t\t\t}\r\n\t\t\t\treturn new Sandbox(domcontainer, this);\r\n\t\t\t}\r\n\t\t},\r\n\t\tInternalConnector: class{\r\n\t\t\tstatic getInstance(){\r\n\t\t\t\tif(!BobbleHead.InternalConnector.instance)\r\n\t\t\t\t\tBobbleHead.InternalConnector.instance = new BobbleHead.InternalConnector();\r\n\t\t\t\treturn BobbleHead.InternalConnector.instance;\r\n\t\t\t}\r\n\t\t\tdoRequest(request){\r\n\t\t\t\treturn new Promise(function(resolve, reject) {\r\n\t\t\t\t\tif(request.uri.startsWith('app://')){\r\n\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\tvar uri = BobbleHead.Router.route(request.uri);\r\n\t\t\t\t\t\t\tvar subUri = uri.substring(6);\r\n\t\t\t\t\t\t\tif(subUri.startsWith('page/')){\r\n\t\t\t\t\t\t\t\tvar num = BobbleHead.Util.vidInURIPattern.exec(subUri.substring(5));\r\n\t\t\t\t\t\t\t\tif(num){\r\n\t\t\t\t\t\t\t\t\tvar vid_str = num[1];\r\n\t\t\t\t\t\t\t\t\tvar context = BobbleHead.Context.getGlobal();\r\n\t\t\t\t\t\t\t\t\tif(vid_str == 'back')\r\n\t\t\t\t\t\t\t\t\t\tcontext.pageBuilder.pageBack();\r\n\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\tcontext.pageBuilder.buildPage(parseInt(vid_str),request.getDataAsObject()).then(resolve).catch(reject);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}else if(subUri.startsWith('module/')){\r\n\t\t\t\t\t\t\t\tvar subSubUri = subUri.substring(7);\r\n\t\t\t\t\t\t\t\tvar n = subSubUri.indexOf('/');\r\n\t\t\t\t\t\t\t\tvar moduleName = null;\r\n\t\t\t\t\t\t\t\tif(n>=0)\r\n\t\t\t\t\t\t\t\t\tmoduleName = subSubUri.substring(0, n);\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tmoduleName = subSubUri;\r\n\t\t\t\t\t\t\t\tvar module = BobbleHead.ModulePool.getModule(moduleName);\r\n\t\t\t\t\t\t\t\tvar subSubSubUri = subSubUri.substring(n+1);\r\n\t\t\t\t\t\t\t\tn = subSubSubUri.indexOf('/');\r\n\t\t\t\t\t\t\t\tvar controllerName = null;\r\n\t\t\t\t\t\t\t\tif(n>=0)\r\n\t\t\t\t\t\t\t\t\tcontrollerName = subSubSubUri.substring(0, n);\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tcontrollerName = subSubSubUri;\r\n\t\t\t\t\t\t\t\tvar controllr = module.getController(controllerName);\r\n\t\t\t\t\t\t\t\tif(controllr!=null)\r\n\t\t\t\t\t\t\t\t\tcontrollr(request.getData(), resolve, reject);\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\treject(new BobbleHead.Exceptions.ControllerNotFoundException());\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\t\treject(e);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tAccessController: class{\r\n\t\t\tgetCurrentSession(){\r\n\t\t\t\tif(this.currentAuthMethod){\r\n\t\t\t\t\tvar sess = this.currentAuthMethod.getCurrentSession();\r\n\t\t\t\t\tif((this.controllerData.session && sess != this.controllerData.session)\r\n\t\t\t\t\t\t|| ((!this.controllerData.session) && sess)){\r\n\t\t\t\t\t\tthis.saveSession(sess);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn sess;\r\n\t\t\t\t}\r\n\t\t\t\treturn this.controllerData.session;\r\n\t\t\t}\r\n\t\t\tsaveSession(sess){\r\n\t\t\t\tvar db = BobbleHead.Database.getInstance();\r\n\t\t\t\tsess._id = 'session';\r\n\t\t\t\tif(this.controllerData.session)\r\n\t\t\t\t\tsess._rev = this.controllerData.session._rev;\r\n\t\t\t\tthis.controllerData.session = sess;\r\n\t\t\t\tdb.put(sess,{rev: true}).then(function (response) {\r\n\t\t\t\t\tthis.controllerData.session._rev = response.rev;\r\n\t\t\t\t\tBobbleHead.log('Saved local session', 0, response);\r\n\t\t\t\t}.bind(this)).catch(function (err) {\r\n\t\t\t\t\tBobbleHead.log('Cannot save local session', 1, err);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tprocessRequest(request){\r\n\t\t\t\tif(this.currentAuthMethod){\r\n\t\t\t\t\tthis.currentAuthMethod.processRequest(request);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tprocessPage(page){\r\n\t\t\t\tif(this.currentAuthMethod){\r\n\t\t\t\t\tthis.currentAuthMethod.processPage(page);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tprocessVirtualPage(vpage){\r\n\t\t\t\tif(this.currentAuthMethod){\r\n\t\t\t\t\tthis.currentAuthMethod.processVirtualPage(vpage);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinit(authType = 'none'){\r\n\t\t\t\treturn new Promise(function(resolve, reject){\r\n\t\t\t\t\tthis.currentAuthMethod = BobbleHead.AuthenticationMethods.getMethod(authType) ||\r\n\t\t\t\t\t\tBobbleHead.AuthenticationMethods.getMethod('none');\r\n\t\t\t\t\tif(!(this.currentAuthMethod instanceof BobbleHead.AuthenticationMethod))\r\n\t\t\t\t\t\tthrow new BobbleHead.Exceptions.InvalidAuthenticationMethodException();\r\n\t\t\t\t\tvar db = BobbleHead.Database.getInstance();\r\n\t\t\t\t\tthis.controllerData = {};\r\n\t\t\t\t\tdb.get('session').then(function(session) {\r\n\t\t\t\t\t\tthis.controllerData.session = new BobbleHead.Session(session.info);\r\n\t\t\t\t\t\tthis.controllerData.session._id = session._id;\r\n\t\t\t\t\t\tthis.controllerData.session._rev = session._rev;\r\n\t\t\t\t\t\tthis.currentAuthMethod.replaceCurrentSession(this.controllerData.session);\r\n\t\t\t\t\t\tBobbleHead.log('Fetched local session', 0, this.controllerData.session);\r\n\t\t\t\t\t\tdocument.dispatchEvent(new BobbleHead.AccessControllerLoadedEvent());\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t}.bind(this)).catch(function(err) {\r\n\t\t\t\t\t\tthis.controllerData.session = null;\r\n\t\t\t\t\t\tBobbleHead.log('Cannot retrive local session', 1, err);\r\n\t\t\t\t\t\tdocument.dispatchEvent(new BobbleHead.AccessControllerLoadedEvent());\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t}.bind(this));\r\n\t\t\t\t}.bind(this)).catch(function(e) {\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tAuthenticationMethod: class{\r\n\t\t\tconstructor(){\r\n\t\t\t\tthis.session = null;\r\n\t\t\t}\r\n\t\t\tprocessRequest(request = null){}\r\n\t\t\tprocessPage(page = null){}\r\n\t\t\tprocessVirtualPage(vpage = null){}\r\n\t\t\tgetCurrentSession(){\r\n\t\t\t\treturn this.session;\r\n\t\t\t}\r\n\t\t\treplaceCurrentSession(session){\r\n\t\t\t\tthis.session = session;\r\n\t\t\t}\r\n\t\t},\r\n\t\tAuthenticationMethods: class{\r\n\t\t\tstatic addMethod(name, method, args = null){\r\n\t\t\t\tBobbleHead.AuthenticationMethods.methods[name] = [method, args];\r\n\t\t\t}\r\n\t\t\tstatic getMethod(name){\r\n\t\t\t\tvar retrive = BobbleHead.AuthenticationMethods.methods[name];\r\n\t\t\t\treturn (retrive) ? (new (BobbleHead.Util.execFuncWithArgList(retrive[0], retrive[1]))()) : null;\r\n\t\t\t}\r\n\t\t},\r\n\t\tExternalConnector: class{\r\n\t\t\tstatic getInstance(){\r\n\t\t\t\tif(!BobbleHead.ExternalConnector.instance)\r\n\t\t\t\t\tBobbleHead.ExternalConnector.instance = new BobbleHead.ExternalConnector();\r\n\t\t\t\treturn BobbleHead.ExternalConnector.instance;\r\n\t\t\t}\r\n\t\t\tdoRequest(request){\r\n\t\t\t\treturn new Promise(function(resolve, reject) {\r\n\t\t\t\t\tvar xhttp = new XMLHttpRequest();\r\n\t\t\t\t\tvar url = encodeURI(request.uri);\r\n\t\t\t\t\tif(request.method == 'get' && request.getData() != null){\r\n\t\t\t\t\t\tvar _param = '';\r\n\t\t\t\t\t\tfor (var pair of request.getData().entries()) {\r\n\t\t\t\t\t\t\tif(pair[0]&&(pair[1] || pair[1]===0))\r\n\t\t\t\t\t\t\t\t_param += pair[0]+'='+pair[1].toString().trim()+'&';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t_param = _param.slice(0, -1);\r\n\t\t\t\t\t\turl += '?'+_param;\r\n\t\t\t\t\t}\r\n\t\t\t\t\txhttp.open(request.getMethod(), url, true);\r\n\t\t\t\t\tfor(var header of request.getHeaders())\r\n\t\t\t\t\t\txhttp.setRequestHeader(header.name, header.value);\r\n\t\t\t\t\txhttp.responseType = 'json';\r\n\t\t\t\t\txhttp.onreadystatechange = async function(){\r\n\t\t\t\t\t\tvar res = new BobbleHead.Response();\r\n\t\t\t\t\t\tif(xhttp.readyState === XMLHttpRequest.DONE){\r\n\t\t\t\t\t\t\tvar response = null;\r\n\t\t\t\t\t\t\tres.code = 0;\r\n\t\t\t\t\t\t\tres.status = xhttp.status;\r\n\t\t\t\t\t\t\tif(xhttp.status !== 200) {\r\n\t\t\t\t\t\t\t\tvar statusType = Math.floor(xhttp.status/100);\r\n\t\t\t\t\t\t\t\tif(statusType!=4){\r\n\t\t\t\t\t\t\t\t\tresponse = BobbleHead.Cacher.getCached(request);\r\n\t\t\t\t\t\t\t\t\tif(response instanceof Promise){\r\n\t\t\t\t\t\t\t\t\t\tvar promise_hold = response;\r\n\t\t\t\t\t\t\t\t\t\tresponse = await promise_hold;\r\n\t\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif(!response){\r\n\t\t\t\t\t\t\t\t\tres.code = -10;\r\n\t\t\t\t\t\t\t\t\tres.content = {'error':'Connection Error'};\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(!response)\r\n\t\t\t\t\t\t\t\tresponse = xhttp.response;\r\n\t\t\t\t\t\t\tif(response){\r\n\t\t\t\t\t\t\t\tres.code = 0;\r\n\t\t\t\t\t\t\t\tres.content = response;\r\n\t\t\t\t\t\t\t}else if(xhttp.status === 200){\r\n\t\t\t\t\t\t\t\tres.code = -11;\r\n\t\t\t\t\t\t\t\tres.content = {'error':'No data response'};\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(xhttp.status === 200){\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cache(request,response);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(res.code==0)\r\n\t\t\t\t\t\t\t\tresolve(res);\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\treject(res);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t};\r\n\t\t\t\t\txhttp.send(request.getData());\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tGenericConnector: class{\r\n\t\t\trequest(request){\r\n\t\t\t\tvar test = BobbleHead.Util.isRemoteURIPattern.test(request.uri);\r\n\t\t\t\tvar connector = null;\r\n\t\t\t\tvar context = BobbleHead.Context.getGlobal();\r\n\t\t\t\tcontext.accessController.processRequest(request);\r\n\t\t\t\tif(!test){\r\n\t\t\t\t\tconnector = BobbleHead.InternalConnector.getInstance();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconnector = BobbleHead.ExternalConnector.getInstance();\r\n\t\t\t\t}\r\n\t\t\t\treturn connector.doRequest(request);\r\n\t\t\t}\r\n\t\t},\r\n\t\tCacher: class{\r\n\t\t\tstatic init(maxcached, whitelist, blacklist){\r\n\t\t\t\treturn new Promise(function(resolve, reject){\r\n\t\t\t\t\tvar db = BobbleHead.Database.getInstance();\r\n\t\t\t\t\tdb.get('cacheMap').then(function(cacheMap) {\r\n\t\t\t\t\t\tif(cacheMap)\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap = cacheMap;\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap = {'_id':'cacheMap', 'length':0};\r\n\t\t\t\t\t\t\tBobbleHead.log('Cacher',0,'Cacher map not found');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdb.get('cacheHeap').then(function(cacheHeap) {\r\n\t\t\t\t\t\t\tif(cacheHeap){\r\n\t\t\t\t\t\t\t\tvar holdNodeArray = [];\r\n\t\t\t\t\t\t\t\tfor(var i in cacheHeap.array){\r\n\t\t\t\t\t\t\t\t\tvar _val = (cacheHeap.array[i]).value;\r\n\t\t\t\t\t\t\t\t\tvar val = new BobbleHead.CacherRequest(_val.method,_val.uri,_val.data,_val.headers);\r\n\t\t\t\t\t\t\t\t\tholdNodeArray.push(new BobbleHead.Util.HeapNode((cacheHeap.array[i]).key, val));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar rev = cacheHeap._rev;\r\n\t\t\t\t\t\t\t\tcacheHeap = new BobbleHead.Util.ReverseHeap(holdNodeArray);\r\n\t\t\t\t\t\t\t\tcacheHeap._id = 'cacheHeap';\r\n\t\t\t\t\t\t\t\tcacheHeap._rev = rev;\r\n\t\t\t\t\t\t\t\tvar hold = cacheHeap.getFirst();\r\n\t\t\t\t\t\t\t\tif(hold!=null){\r\n\t\t\t\t\t\t\t\t\tvar red = hold.getKey()-1;\r\n\t\t\t\t\t\t\t\t\tif(red>0)\r\n\t\t\t\t\t\t\t\t\t\tfor(var node of cacheHeap.getNodes())\r\n\t\t\t\t\t\t\t\t\t\t\tnode.reduceKey(red);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap = cacheHeap;\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap = new BobbleHead.Util.ReverseHeap();\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap._id = 'cacheHeap';\r\n\t\t\t\t\t\t\t\tBobbleHead.log('Cacher',0,'Cacher heap not found');\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdocument.dispatchEvent(new BobbleHead.CacherLoadedEvent());\r\n\t\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t\t}).catch(function(err) {\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap = new BobbleHead.Util.ReverseHeap();\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap._id = 'cacheHeap';\r\n\t\t\t\t\t\t\tBobbleHead.log('Cacher heap not found', 1, err);\r\n\t\t\t\t\t\t\tdocument.dispatchEvent(new BobbleHead.CacherLoadedEvent());\r\n\t\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}).catch(function(err) {\r\n\t\t\t\t\t\tBobbleHead.Cacher.cacheMap = {'_id':'cacheMap', 'length':0};\r\n\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap = new BobbleHead.Util.ReverseHeap();\r\n\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap._id = 'cacheHeap';\r\n\t\t\t\t\t\tBobbleHead.log('Cacher map not found', 1, err);\r\n\t\t\t\t\t\tdocument.dispatchEvent(new BobbleHead.CacherLoadedEvent());\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t});\r\n\t\t\t\t\tBobbleHead.Cacher.whitelist = whitelist;\r\n\t\t\t\t\tBobbleHead.Cacher.blacklist = blacklist;\r\n\t\t\t\t\tBobbleHead.Cacher.maxCached = maxcached;\r\n\t\t\t\t}.bind(this)).catch(function(e) {\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tstatic parseUri(uri){\r\n\t\t\t\tvar parsed_uri = btoa(uri);\r\n\t\t\t\tvar toTrim = 0;\r\n\t\t\t\tfor(var i = (parsed_uri.length -1); i>=0; i--)\r\n\t\t\t\t\tif(parsed_uri[i] == '=')\r\n\t\t\t\t\t\ttoTrim++;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\tif(toTrim>0)\r\n\t\t\t\t\treturn parsed_uri.substring(0, parsed_uri.length - toTrim);\r\n\t\t\t\telse\r\n\t\t\t\t\treturn parsed_uri;\r\n\t\t\t}\r\n\t\t\tstatic cache(request, response){\r\n\t\t\t\tvar hold_request = request.toCacherRequest();\r\n\t\t\t\tvar cache_converted_request_func = function(response, obj){\r\n\t\t\t\t\tvar request = obj.pop();\r\n\t\t\t\t\tif(BobbleHead.Cacher.blacklist.indexOf(request.uri) == -1){\r\n\t\t\t\t\t\tvar db = BobbleHead.Database.getInstance();\r\n\t\t\t\t\t\tvar parsed_uri = BobbleHead.Cacher.parseUri(request.uri);\r\n\t\t\t\t\t\tvar found = -1;\r\n\t\t\t\t\t\tif(BobbleHead.Cacher.cacheMap[request.method] &&\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method][parsed_uri]){\r\n\t\t\t\t\t\t\t\tfor(var i in BobbleHead.Cacher.cacheMap[request.method][parsed_uri]){\r\n\t\t\t\t\t\t\t\t\tif(!(BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0] instanceof BobbleHead.CacherRequest))\r\n\t\t\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0] = BobbleHead.CacherRequest.fromObject(BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0]);\r\n\t\t\t\t\t\t\t\t\tif(request.equal(BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0])){\r\n\t\t\t\t\t\t\t\t\t\tfound = i;\r\n\t\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(found != -1){\r\n\t\t\t\t\t\t\tvar hold = BobbleHead.Cacher.cacheHeap.findByValue(request);\r\n\t\t\t\t\t\t\tvar incNodeFunc = function(db, ele){\r\n\t\t\t\t\t\t\t\tele.incKey();\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap.reheap();\r\n\t\t\t\t\t\t\t\tdb.put(BobbleHead.Cacher.cacheHeap,{rev: true}).then(function (response) {\r\n\t\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap._rev = response.rev;\r\n\t\t\t\t\t\t\t\t\tBobbleHead.log('Saved Cacher heap', 0, response);\r\n\t\t\t\t\t\t\t\t}).catch(function (err) {\r\n\t\t\t\t\t\t\t\t\tBobbleHead.log('Cannot save Cacher heap', 1, err);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method][parsed_uri][found][1] = response;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(hold!=null)\r\n\t\t\t\t\t\t\t\thold.then(incNodeFunc.bind(this, db)).catch(function(){BobbleHead.log('URL in whitelist', 0, 'Cannot retrive node from Cacher heap')});\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tif(BobbleHead.Cacher.cacheMap.length > BobbleHead.Cacher.maxCached)\r\n\t\t\t\t\t\t\t\tfor(var i = BobbleHead.Cacher.nodesPartNum; i>0; i--){\r\n\t\t\t\t\t\t\t\t\tvar hold = BobbleHead.Cacher.cacheHeap.pop();\r\n\t\t\t\t\t\t\t\t\tvar reqToDel = hold.getValue();\r\n\t\t\t\t\t\t\t\t\tvar parsed_toDelUri = BobbleHead.Cacher.parseUri(reqToDel.uri);\r\n\t\t\t\t\t\t\t\t\tfor(var j = (BobbleHead.Cacher.cacheMap[reqToDel.method][parsed_toDelUri]).length; j>0; j--){\r\n\t\t\t\t\t\t\t\t\t\tvar _req = (BobbleHead.Cacher.cacheMap[reqToDel.method][parsed_toDelUri]).shift();\r\n\t\t\t\t\t\t\t\t\t\tif(!reqToDel.equal(_req[0])){\r\n\t\t\t\t\t\t\t\t\t\t\tif(!(_req[0] instanceof BobbleHead.CacherRequest))\r\n\t\t\t\t\t\t\t\t\t\t\t\t_req[0] = BobbleHead.CacherRequest.fromObject(_req[0]);\r\n\t\t\t\t\t\t\t\t\t\t\t(BobbleHead.Cacher.cacheMap[reqToDel.method][parsed_toDelUri]).push(_req);\r\n\t\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap.length--;\r\n\t\t\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(BobbleHead.Cacher.whitelist.indexOf(request.uri) == -1){\r\n\t\t\t\t\t\t\t\tvar node = new BobbleHead.Util.HeapNode(1,request);\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap.addNode(node);\r\n\t\t\t\t\t\t\t\tdb.put(BobbleHead.Cacher.cacheHeap,{rev: true}).then(function (response) {\r\n\t\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheHeap._rev = response.rev;\r\n\t\t\t\t\t\t\t\t\tBobbleHead.log('Saved Cacher heap', 0, response);\r\n\t\t\t\t\t\t\t\t}).catch(function (err) {\r\n\t\t\t\t\t\t\t\t\tBobbleHead.log('Cannot save Cacher heap', 1, err);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(!BobbleHead.Cacher.cacheMap[request.method])\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method] = {};\r\n\t\t\t\t\t\t\tif(!BobbleHead.Cacher.cacheMap[request.method][parsed_uri])\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method][parsed_uri] = [];\r\n\t\t\t\t\t\t\t(BobbleHead.Cacher.cacheMap[request.method][parsed_uri]).push([request, response]);\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap.length++;\r\n\t\t\t\t\t\t\tdb.put(BobbleHead.Cacher.cacheMap,{rev: true}).then(function (response) {\r\n\t\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap._rev = response.rev;\r\n\t\t\t\t\t\t\t\tBobbleHead.log('Saved Cacher map', 0, response);\r\n\t\t\t\t\t\t\t}).catch(function (err) {\r\n\t\t\t\t\t\t\t\tBobbleHead.log('Cannot save Cacher map', 1, err);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tif(!(hold_request instanceof BobbleHead.CacherRequest))\r\n\t\t\t\t\tPromise.all(hold_request).then(cache_converted_request_func.bind(this, response));\r\n\t\t\t\telse\r\n\t\t\t\t\t(cache_converted_request_func.bind(this))(response, [hold_request]);\r\n\t\t\t}\r\n\t\t\tstatic getCached(request){\r\n\t\t\t\tvar parsed_uri = BobbleHead.Cacher.parseUri(request.uri);\r\n\t\t\t\tvar promises = [];\r\n\t\t\t\tif(BobbleHead.Cacher.cacheMap[request.method] &&\r\n\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method][parsed_uri])\r\n\t\t\t\t\tfor(var i in BobbleHead.Cacher.cacheMap[request.method][parsed_uri]){\r\n\t\t\t\t\t\tif(!(BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0] instanceof BobbleHead.CacherRequest))\r\n\t\t\t\t\t\t\tBobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0] = BobbleHead.CacherRequest.fromObject(BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0]);\r\n\t\t\t\t\t\tvar compareResult = request.equal(BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][0]);\r\n\t\t\t\t\t\tif(compareResult instanceof Promise)\r\n\t\t\t\t\t\t\tpromises.push(compareResult.then(function(_method, _uri, _i, flag){\r\n\t\t\t\t\t\t\t\tif(flag)\r\n\t\t\t\t\t\t\t\t\treturn this[_method][_uri][_i][1];\r\n\t\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t\t}.bind(BobbleHead.Cacher.cacheMap, request.method, parsed_uri, i)));\r\n\t\t\t\t\t\telse if(compareResult == true)\r\n\t\t\t\t\t\t\treturn BobbleHead.Cacher.cacheMap[request.method][parsed_uri][i][1];\r\n\t\t\t\t\t}\r\n\t\t\t\tif(promises.length > 0)\r\n\t\t\t\t\treturn Promise.all(promises).then(function(response){\r\n\t\t\t\t\t\tfor(var i=0; i<response.length; i++)\r\n\t\t\t\t\t\t\tif(response[i] != null)\r\n\t\t\t\t\t\t\t\treturn response[i];\r\n\t\t\t\t\t});\r\n\t\t\t\telse\r\n\t\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t},\r\n\t\tPageBuilder: class {\r\n\t\t\tconstructor(){\r\n\t\t\t\tthis.pageStack = [];\r\n\t\t\t\tthis.container = null;\r\n\t\t\t\tthis.documentProxy = null;\r\n\t\t\t\tthis.currentPage = null;\r\n\t\t\t}\r\n\t\t\tcheckPage(page){\r\n\t\t\t\tvar context = BobbleHead.Context.getGlobal();\r\n\t\t\t\tcontext.accessController.processPage(page);\r\n\t\t\t}\r\n\t\t\tcheckVirtualPage(vpage){\r\n\t\t\t\tvar context = BobbleHead.Context.getGlobal();\r\n\t\t\t\tcontext.accessController.processVirtualPage(vpage);\r\n\t\t\t}\r\n\t\t\tpageHop(){\r\n\t\t\t\tvar newdomcontainer = document.getElementById(this.container);\r\n\t\t\t\tfor(var i = 100; i>=0; i--){\r\n\t\t\t\t\tnewdomcontainer.style.left = i+'%';\r\n\t\t\t\t}\r\n\t\t\t\tnewdomcontainer.style.position = '';\r\n\t\t\t\tnewdomcontainer.style.float = 'none';\r\n\t\t\t\tdocument.body.removeChild(document.getElementById(\"snapPageIframe\"));\r\n\t\t\t}\r\n\t\t\tsetDefaultListener(context, container){\r\n\t\t\t\tif(container instanceof Element){\r\n\t\t\t\t\tif(container.tagName.toUpperCase() == 'A')\r\n\t\t\t\t\t\tvar a = [container];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tvar a = container.getElementsByTagName(\"a\");\r\n\t\t\t\t\tfor(var i=0; i<a.length; i++){\r\n\t\t\t\t\t\tif(!a[i].hasAttribute('bbh-ignore') && !BobbleHead.Util.isRemoteURIPattern.test(a[i].getAttribute('href')))\r\n\t\t\t\t\t\t\ta[i].onclick = function(connector){\r\n\t\t\t\t\t\t\t\tvar req = new BobbleHead.ConnectorRequest('GET', this.getAttribute('href'), null); //TODO: data-*\r\n\t\t\t\t\t\t\t\tconnector.request(req);\r\n\t\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t\t}.bind(a[i],context.defaultConnector);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(container.tagName.toUpperCase() == 'FORM')\r\n\t\t\t\t\t\tvar f = [container];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tvar f = container.getElementsByTagName(\"form\");\r\n\t\t\t\t\tfor(var i=0; i<f.length; i++){\r\n\t\t\t\t\t\tif(!f[i].hasAttribute('bbh-ignore')){\r\n\t\t\t\t\t\t\tf[i].onsubmit = function(connector){\r\n\t\t\t\t\t\t\t\tfor(var e of this.querySelectorAll('[name]')){\r\n\t\t\t\t\t\t\t\t\tif(!e.checkValidity()){\r\n\t\t\t\t\t\t\t\t\t\te.reportValidity();\r\n\t\t\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar data = new FormData(this);\r\n\t\t\t\t\t\t\t\tvar req = new BobbleHead.ConnectorRequest(this.getAttribute('method'), this.getAttribute('action'), data);\r\n\t\t\t\t\t\t\t\tconnector.request(req);\r\n\t\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t\t}.bind(f[i],context.defaultConnector);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tgetNewContainer(toHistory, prevPageSrc=\"about:blank\"){\r\n\t\t\t\tvar domcontainer = document.getElementById(this.container);\r\n\t\t\t\tdomcontainer.setAttribute(\"id\", this.container+'-toDelete');\r\n\t\t\t\tvar newdomcontainer = document.createElement(\"div\");\r\n\t\t\t\tnewdomcontainer.setAttribute(\"id\", this.container);\r\n\t\t\t\tnewdomcontainer.style.left = '100%';\r\n\t\t\t\tnewdomcontainer.style.width = '100%';\r\n\t\t\t\tnewdomcontainer.style.float = 'left';\r\n\t\t\t\tnewdomcontainer.style.position = 'absolute';\r\n\t\t\t\tdocument.body.appendChild(newdomcontainer);\r\n\t\t\t\tvar newIframe = document.createElement('iframe');\r\n\t\t\t\tnewIframe.id = \"snapPageIframe\";\r\n\t\t\t\tnewIframe.width = '100%';newIframe.height = '100%';\r\n\t\t\t\tnewIframe.src = prevPageSrc;\r\n\t\t\t\tdocument.body.appendChild(newIframe);\r\n\t\t\t\tif(!toHistory)\r\n\t\t\t\t\tdocument.body.removeChild(domcontainer);\r\n\t\t\t\telse{\r\n\t\t\t\t\tvar hNum = (document.querySelectorAll('*[id^=\"historyPage-\"]').length);\r\n\t\t\t\t\tdomcontainer.setAttribute('id', 'historyPage-'+hNum);\r\n\t\t\t\t\tdomcontainer.style.display = 'none';\r\n\t\t\t\t\tvar eleIds = domcontainer.querySelectorAll('*[id]');\r\n\t\t\t\t\tfor(var i = 0; i<eleIds.length; i++){\r\n\t\t\t\t\t\teleIds[i].id += '-history'+hNum;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn newdomcontainer;\r\n\t\t\t}\r\n\t\t\tbuildPage(virtualID, data){\r\n\t\t\t\treturn new Promise(function(resolve, reject) {\r\n\t\t\t\t\tvar page = BobbleHead.PageFactory.getPage(virtualID);\r\n\t\t\t\t\tif(page){\r\n\t\t\t\t\t\tvar toHistory = false;\r\n\t\t\t\t\t\tvar ghosting = false;\r\n\t\t\t\t\t\tif(this.currentPage && this.currentPage.page.ghostPage){\r\n\t\t\t\t\t\t\tthis.currentPage = this.pageStack.pop() || null;\r\n\t\t\t\t\t\t\tghosting = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(!page.lock && this.currentPage!=null && (page.vid != this.currentPage.page.vid || page.allowDuplicate)){\r\n\t\t\t\t\t\t\tif(!ghosting && this.currentPage.page.keepLive)\r\n\t\t\t\t\t\t\t\ttoHistory = true;\r\n\t\t\t\t\t\t\tthis.pageStack.push(this.currentPage);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(page.lock)\r\n\t\t\t\t\t\t\tthis.pageStack = [];\r\n\t\t\t\t\t\tvar domcontainer = this.getNewContainer(toHistory, (this.currentPage) ? this.currentPage.page.path : undefined);\r\n\t\t\t\t\t\tvar pageContx = new BobbleHead.PageContext(domcontainer);\r\n\t\t\t\t\t\tthis.currentPage = new BobbleHead.VirtualPage(page, data, pageContx, resolve, reject);\r\n\t\t\t\t\t\tthis.checkVirtualPage(this.currentPage);\r\n\t\t\t\t\t\tthis.buildPageByObject(page, data, pageContx, resolve, reject);\r\n\t\t\t\t\t\tthis.pageHop();\r\n\t\t\t\t\t}else\r\n\t\t\t\t\t\treject(new BobbleHead.Exceptions.PageNotFoundException());\r\n\t\t\t\t}.bind(this)).catch(function(e) {\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tbuildPageFromHistory(historyNum, prevPageSrc){\r\n\t\t\t\tvar domcontainer = document.getElementById(this.container);\r\n\t\t\t\tdomcontainer.setAttribute(\"id\", this.container+'-toDelete');\r\n\t\t\t\tvar newdomcontainer = document.getElementById('historyPage-'+historyNum);\r\n\t\t\t\tvar newIframe = document.createElement('iframe');\r\n\t\t\t\tnewIframe.id = \"snapPageIframe\";\r\n\t\t\t\tnewIframe.width = '100%';newIframe.height = '100%';\r\n\t\t\t\tnewIframe.src = prevPageSrc;\r\n\t\t\t\tdocument.body.appendChild(newIframe);\r\n\t\t\t\tdocument.body.removeChild(domcontainer);\r\n\t\t\t\tnewdomcontainer.setAttribute('id', this.container);\r\n\t\t\t\tnewdomcontainer.style.display = 'inline';\r\n\t\t\t\tvar eleIds = newdomcontainer.querySelectorAll('*[id]');\r\n\t\t\t\tvar toTrim = ('-history'+historyNum).length;\r\n\t\t\t\tfor(var i = 0; i<eleIds.length; i++){\r\n\t\t\t\t\teleIds[i].id = (eleIds[i].id).substring(0, (eleIds[i].id).length - toTrim);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tasync buildPageByText(html, data, sandbox, modulesToLoad, onSuccess, onFailure){\r\n\t\t\t\t\tvar context = BobbleHead.Context.getGlobal();\r\n\t\t\t\t\tvar appContainer = document.getElementById(this.container);\r\n\t\t\t\t\tappContainer.innerHTML = Mustache.render(html,\r\n\t\t\t\t\t\t{pageData: data, models: BobbleHead.ModelPool.getModels()});\r\n\t\t\t\t\tvar observer = new MutationObserver(function(context, mutationsList){\r\n\t\t\t\t\t\tfor(var mutation of mutationsList) {\r\n\t\t\t\t\t\t\tif (mutation.type == 'childList') {\r\n\t\t\t\t\t\t\t\tfor(var x of mutation.addedNodes){\r\n\t\t\t\t\t\t\t\t\tthis.setDefaultListener(context, x);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}.bind(this,context));\r\n\t\t\t\t\tobserver.observe(appContainer, { subtree: true, childList: true });\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar js = appContainer.getElementsByTagName(\"script\");\r\n\t\t\t\t\tvar lastscript = null;\r\n\t\t\t\t\tfor(var i=0; i<js.length; i++){\r\n\t\t\t\t\t\tvar nsync = js[i].getAttribute('async');\r\n\t\t\t\t\t\tif(js[i].getAttribute('src')!=\"\" && js[i].getAttribute('src')!=null){\r\n\t\t\t\t\t\t\tvar scriptfile = js[i].getAttribute('src');\r\n\t\t\t\t\t\t\tif(nsync != 'true' && lastscript != null)\r\n\t\t\t\t\t\t\t\tawait lastscript;\r\n\t\t\t\t\t\t\tvar scriptprom = new Promise(function(resolve, reject){\r\n\t\t\t\t\t\t\t\tvar xhttp2 = new XMLHttpRequest();\r\n\t\t\t\t\t\t\t\txhttp2.open('get', scriptfile, true);\r\n\t\t\t\t\t\t\t\txhttp2.responseType = 'text';\r\n\t\t\t\t\t\t\t\txhttp2.onreadystatechange = function(sandbox,sf){\r\n\t\t\t\t\t\t\t\t\tif(xhttp2.readyState === XMLHttpRequest.DONE){\r\n\t\t\t\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\t\t\t\tsandbox.execCode(xhttp2.response);\r\n\t\t\t\t\t\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\t\t\t\t\t\tBobbleHead.log('Execution of scriptfile: '+sf, 3, e);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}.bind(this,sandbox,scriptfile);\r\n\t\t\t\t\t\t\t\txhttp2.send();\r\n\t\t\t\t\t\t\t}).catch(function(e) {\r\n\t\t\t\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tif(nsync != 'true')\r\n\t\t\t\t\t\t\t\tlastscript = scriptprom;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\tsandbox.execCode(js[i].innerHTML);\r\n\t\t\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\t\t\tBobbleHead.log('Execution of script code', 3, e);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.setDefaultListener(context, appContainer);\r\n\t\t\t\t\tvar pageloadpromises = (lastscript == null) ? [] : [lastscript];\r\n\t\t\t\t\tfor(var mod of BobbleHead.ModulePool.getModules()){\r\n\t\t\t\t\t\tif(modulesToLoad != null && modulesToLoad.indexOf(mod.name)>-1)\r\n\t\t\t\t\t\t\tfor(var e of appContainer.querySelectorAll('[bbh-module*=\"'+mod.name+'\"]')){\r\n\t\t\t\t\t\t\t\te.setAttribute('bbh-manipulating','true');\r\n\t\t\t\t\t\t\t\tvar sand = new Sandbox(e, context.clone());\r\n\t\t\t\t\t\t\t\tvar modpromise = sand.execMethod('manipulate', [], mod);\r\n\t\t\t\t\t\t\t\tif(modpromise !== undefined)\r\n\t\t\t\t\t\t\t\t\tif(modpromise instanceof Promise)\r\n\t\t\t\t\t\t\t\t\t\tmodpromise.then(function(){\r\n\t\t\t\t\t\t\t\t\t\t\te.setAttribute('bbh-manipulating','false');\r\n\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\tthrow new BobbleHead.Exceptions.FrameworkException(mod.name+' manipulate has not returned a promise');\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\te.setAttribute('bbh-manipulating','false');\r\n\t\t\t\t\t\t\t\tpageloadpromises.push(modpromise);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tPromise.all(pageloadpromises).then(function(){\r\n\t\t\t\t\t\tdocument.dispatchEvent(new BobbleHead.PageReadyEvent());\r\n\t\t\t\t\t\tappContainer.dispatchEvent(new BobbleHead.PageReadyEvent());\r\n\t\t\t\t\t\tonSuccess();\r\n\t\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tbuildPageByObject(page, data, pageContext, onSuccess = BobbleHead.defaultCallback, onFailure = BobbleHead.defaultCallback){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tthis.checkPage(page);\r\n\t\t\t\t\tvar xhttp = new XMLHttpRequest();\r\n\t\t\t\t\txhttp.open(\"GET\", page.path, true);\r\n\t\t\t\t\txhttp.onreadystatechange = async function(data, sandbox, modulesToLoad, onSuccess, onFailure){\r\n\t\t\t\t\t\tif(xhttp.readyState === XMLHttpRequest.DONE && xhttp.status === 404)\r\n\t\t\t\t\t\t\tonFailure(new BobbleHead.Exceptions.PageNotFoundException());\r\n\t\t\t\t\t\telse if(xhttp.readyState === XMLHttpRequest.DONE){\r\n\t\t\t\t\t\t\tthis.buildPageByText(xhttp.response, data, sandbox, modulesToLoad, onSuccess, onFailure);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}.bind(this, data, pageContext, page.modules, onSuccess, onFailure);\r\n\t\t\t\t\txhttp.send(null);\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tonFailure(e);\r\n\t\t\t\t\tif(e instanceof BobbleHead.Exceptions.RedirectException)\r\n\t\t\t\t\t\tif(e.vid == -1)\r\n\t\t\t\t\t\t\tthis.pageBack();\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tthis.buildPage(e.vid, e.data);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tpageBack(){\r\n\t\t\t\tvar vpage = this.pageStack.pop();\r\n\t\t\t\tif(vpage){\r\n\t\t\t\t\tthis.currentPage = vpage;\r\n\t\t\t\t\tthis.checkVirtualPage(vpage);\r\n\t\t\t\t\tif(vpage.page.keepLive){\r\n\t\t\t\t\t\tvar hNum = (document.querySelectorAll('*[id^=\"historyPage-\"]').length);\r\n\t\t\t\t\t\tthis.buildPageFromHistory(hNum - 1, vpage.page.path);\r\n\t\t\t\t\t\tthis.pageHop();\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tthis.getNewContainer(false, vpage.page.path);\r\n\t\t\t\t\t\tthis.buildPageByObject(vpage.page, vpage.data, vpage.context, vpage.success, vpage.fail);\r\n\t\t\t\t\t\tthis.pageHop();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else\r\n\t\t\t\t\tthrow new BobbleHead.Exceptions.PageNotFoundException();\r\n\t\t\t}\r\n\t\t},\r\n\t\tPageFactory: {\r\n\t\t\tpages: {},\r\n\t\t\tgetPage: function(virtualID){\r\n\t\t\t\treturn BobbleHead.PageFactory.pages[virtualID];\r\n\t\t\t},\r\n\t\t\taddPage: function(page){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tBobbleHead.PageFactory.pages[page.vid] = page;\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tModule: class{\r\n\t\t\tconstructor(name){\r\n\t\t\t\tthis.name = name;\r\n\t\t\t\tthis.configuration = {};\r\n\t\t\t\tthis.__controllers = {};\r\n\t\t\t}\r\n\t\t\tcontroller(name, routine){\r\n\t\t\t\tthis.__controllers[name] = routine.bind(this);\r\n\t\t\t\treturn this;\r\n\t\t\t}\r\n\t\t\tgetController(name){\r\n\t\t\t\treturn this.__controllers[name];\r\n\t\t\t}\r\n\t\t\tinit(configuration){\r\n\t\t\t\tthis.configuration = configuration;\r\n\t\t\t}\r\n\t\t\tmanipulate(){}\r\n\t\t},\r\n\t\tModulePool: class{\r\n\t\t\tstatic *getModules(){\r\n\t\t\t\tfor(var x in BobbleHead.ModulePool.modules){\r\n\t\t\t\t\tif(BobbleHead.ModulePool.modules[x] instanceof BobbleHead.Module)\r\n\t\t\t\t\t\tyield BobbleHead.ModulePool.modules[x];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tstatic getModule(name){\r\n\t\t\t\treturn BobbleHead.ModulePool.modules[name];\r\n\t\t\t}\r\n\t\t\tstatic addModule(module){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tBobbleHead.ModulePool.modules[module.name] = module;\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tVirtualPage: class{\r\n\t\t\tconstructor(page, data, context, success, fail){\r\n\t\t\t\tthis.page = page;\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.context = context;\r\n\t\t\t\tthis.success = success;\r\n\t\t\t\tthis.fail = fail;\r\n\t\t\t}\r\n\t\t},\r\n\t\tDatabase: class{\r\n\t\t\tstatic getInstance(){\r\n\t\t\t\tif(BobbleHead.Database.instance == null){\r\n\t\t\t\t\tBobbleHead.Database.instance = new PouchDB('bobblehead');\r\n\t\t\t\t\tif (!BobbleHead.Database.instance.adapter)\r\n\t\t\t\t\t\tBobbleHead.Database.instance = new PouchDB('bobblehead');\r\n\t\t\t\t}\r\n\t\t\t\treturn BobbleHead.Database.instance;\r\n\t\t\t}\r\n\t\t},\r\n\t\tAppController: class{\r\n\t\t\tconstructor(xmlConfiguration){\r\n\t\t\t\tthis.moduleOnLoad = [];\r\n\t\t\t\tthis.initialization = true;\r\n\t\t\t\tBobbleHead.XMLParser.parseUrl(xmlConfiguration,this.processConf.bind(this));\r\n\t\t\t}\r\n\t\t\tregisterModel(model){\r\n\t\t\t\tBobbleHead.ModelPool.addModel(model);\r\n\t\t\t}\r\n\t\t\tregisterModule(module){\r\n\t\t\t\tif(this.initialization)\r\n\t\t\t\t\tthis.moduleOnLoad.push(module);\r\n\t\t\t\telse\r\n\t\t\t\t\tBobbleHead.ModulePool.addModule(module);\r\n\t\t\t}\r\n\t\t\tregisterRoute(route){\r\n\t\t\t\tBobbleHead.Router.addRoute(route);\r\n\t\t\t}\r\n\t\t\tprocessConf(conf){\r\n\t\t\t\tif(!conf) return;\r\n\t\t\t\tvar hold_conf = {};\r\n\t\t\t\ttry{\r\n\t\t\t\t\tvar temp_configuration = conf.getElementsByTagName('configuration')[0];\r\n\t\t\t\t\thold_conf.container = (temp_configuration.getElementsByTagName('container')[0]).textContent;\r\n\t\t\t\t\tif((temp_configuration.getElementsByTagName('base_url')).length>0)\r\n\t\t\t\t\t\thold_conf.base_url = (temp_configuration.getElementsByTagName('base_url')[0]).textContent;\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\tvar path = document.location.pathname.split('/');\r\n\t\t\t\t\t\tpath.pop();\r\n\t\t\t\t\t\thold_conf.base_url = document.location.protocol + '//' + document.location.host + path.join('/');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar pageBuilder_conf = (temp_configuration.getElementsByTagName('pageBuilder')[0]);\r\n\t\t\t\t\tvar cache_whitelist = [];\r\n\t\t\t\t\tvar cache_blacklist = [];\r\n\t\t\t\t\tvar cache_maxcached = 1000;\r\n\t\t\t\t\tvar cacher_conf = (temp_configuration.getElementsByTagName('cacher')[0]);\r\n\t\t\t\t\tif(cacher_conf){\r\n\t\t\t\t\t\tif(cacher_conf.getAttribute('max-cached'))\r\n\t\t\t\t\t\t\tcache_maxcached = parseInt(cacher_conf.getAttribute('max-cached'));\r\n\t\t\t\t\t\tif(cacher_conf.getElementsByTagName('block'))\r\n\t\t\t\t\t\t\tfor( var b of cacher_conf.getElementsByTagName('block')){\r\n\t\t\t\t\t\t\t\tcache_blacklist.push(b.getAttribute('url'));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(cacher_conf.getElementsByTagName('persist'))\r\n\t\t\t\t\t\t\tfor( var p of cacher_conf.getElementsByTagName('persist')){\r\n\t\t\t\t\t\t\t\tcache_whitelist.push(p.getAttribute('url'));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar cacher_promise = BobbleHead.Cacher.init(cache_maxcached, cache_whitelist, cache_blacklist);\r\n\t\t\t\t\tvar page_container = temp_configuration.getElementsByTagName('pages')[0];\r\n\t\t\t\t\tvar pages_index = page_container.getElementsByTagName('index')[0];\r\n\t\t\t\t\tvar pages_path = page_container.getAttribute('path');\r\n\t\t\t\t\tfor( var p of page_container.getElementsByTagName('page')){\r\n\t\t\t\t\t\tvar modulesAll = null;\r\n\t\t\t\t\t\tvar rolesAllowed = null;\r\n\t\t\t\t\t\tif(p.getAttribute('modulesAllowed'))\r\n\t\t\t\t\t\t\tmodulesAll = p.getAttribute('modulesAllowed').split(',');\r\n\t\t\t\t\t\tif(p.getAttribute('rolesAllowed'))\r\n\t\t\t\t\t\t\trolesAllowed = p.getAttribute('rolesAllowed').split(',');\r\n\t\t\t\t\t\tvar hold_vconf = {};\r\n\t\t\t\t\t\tfor(var c of (p.getElementsByTagName('configuration')[0]).childNodes){\r\n\t\t\t\t\t\t\tif(c instanceof Element)\r\n\t\t\t\t\t\t\t\thold_vconf[c.tagName] = c.textContent;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar confPage = new BobbleHead.PageConfiguration(hold_vconf);\r\n\t\t\t\t\t\tvar newPage = new BobbleHead.Page(p.getAttribute('path'), //pages_path+\r\n\t\t\t\t\t\t\tparseInt(p.getAttribute('vid')),(p.getAttribute('noback')=='true'),confPage, modulesAll,\r\n\t\t\t\t\t\t\t(p.hasAttribute('keepLive')) ? (p.getAttribute('keepLive')=='true') : undefined,\r\n\t\t\t\t\t\t\t(p.hasAttribute('allowDuplicate')) ? (p.getAttribute('allowDuplicate')=='true') : undefined,\r\n\t\t\t\t\t\t\t(p.hasAttribute('ghostPage')) ? (p.getAttribute('ghostPage')=='true') : undefined);\r\n\t\t\t\t\t\tBobbleHead.PageFactory.addPage(newPage);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tBobbleHead.AppController.configuration = new BobbleHead.GenericConfiguration(hold_conf);\r\n\t\t\t\t\tvar route_container = temp_configuration.getElementsByTagName('routes')[0];\r\n\t\t\t\t\tif(route_container){\r\n\t\t\t\t\t\tfor( var r of route_container.getElementsByTagName('route')){\r\n\t\t\t\t\t\t\tthis.registerRoute(new BobbleHead.Route(r.getAttribute('entry'), r.getAttribute('destination')));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar module_container = temp_configuration.getElementsByTagName('modules')[0];\r\n\t\t\t\t\tvar current_promise = null;\r\n\t\t\t\t\tif(module_container){\r\n\t\t\t\t\t\tvar modules_path = module_container.getAttribute('path');\r\n\t\t\t\t\t\tif(!modules_path.startsWith(hold_conf.base_url))\r\n\t\t\t\t\t\t\tmodules_path = BobbleHead.Util.absoluteURL(hold_conf.base_url, modules_path, false);\r\n\t\t\t\t\t\tvar moduleConfs = {};\r\n\t\t\t\t\t\tfor( var m of module_container.getElementsByTagName('module')){\r\n\t\t\t\t\t\t\tif(m.getAttribute('enabled') == 'true'){\r\n\t\t\t\t\t\t\t\tvar hold_mconf = {};\r\n\t\t\t\t\t\t\t\tfor(var c of (m.getElementsByTagName('configuration')[0]).childNodes){\r\n\t\t\t\t\t\t\t\t\tif(c instanceof Element)\r\n\t\t\t\t\t\t\t\t\t\thold_mconf[c.tagName] = c.textContent;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar confModule = new BobbleHead.ModuleConfiguration(hold_mconf);\r\n\t\t\t\t\t\t\t\t//TODO: Replace with ES6 'import' when fully-compatible\r\n\t\t\t\t\t\t\t\tcurrent_promise = new Promise(\r\n\t\t\t\t\t\t\t\t\tfunction(confModule, current_promise, resolve, reject){\r\n\t\t\t\t\t\t\t\t\t\tvar mod_load_func = function(confModule, resolve){\r\n\t\t\t\t\t\t\t\t\t\t\tvar script = document.createElement(\"script\");\r\n\t\t\t\t\t\t\t\t\t\t\tscript.src = modules_path + m.getAttribute('path');\r\n\t\t\t\t\t\t\t\t\t\t\tscript.onload = function(modules, configuration, callback){\r\n\t\t\t\t\t\t\t\t\t\t\t\twhile(modules.length>0){\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tvar sm = modules.shift();\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tmoduleConfs[sm.name] = configuration;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tBobbleHead.ModulePool.addModule(sm);\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\tcallback();\r\n\t\t\t\t\t\t\t\t\t\t\t}.bind(script, this.moduleOnLoad, confModule, resolve);\r\n\t\t\t\t\t\t\t\t\t\t\tdocument.head.appendChild(script);\r\n\t\t\t\t\t\t\t\t\t\t}.bind(this, confModule, resolve);\r\n\t\t\t\t\t\t\t\t\t\tif(current_promise!=null)\r\n\t\t\t\t\t\t\t\t\t\t\tcurrent_promise.then(mod_load_func);\r\n\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\tmod_load_func(confModule, resolve);\r\n\t\t\t\t\t\t\t\t\t}.bind(this, confModule, current_promise)\r\n\t\t\t\t\t\t\t\t).catch(function(e) {\r\n\t\t\t\t\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar newBase = document.createElement(\"base\");\r\n\t\t\t\t\tnewBase.setAttribute(\"href\", pages_path);\r\n\t\t\t\t\tdocument.getElementsByTagName(\"head\")[0].appendChild(newBase);\r\n\t\t\t\t\tPromise.all([cacher_promise, current_promise]).then(function(){\r\n\t\t\t\t\t\tvar globalContext = BobbleHead.Context.getGlobal();\r\n\t\t\t\t\t\tif(pageBuilder_conf){\r\n\t\t\t\t\t\t\tpageBuilder_conf = pageBuilder_conf.textContent;\r\n\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\tglobalContext.pageBuilder = new (BobbleHead.Util.getClassFromName(pageBuilder_conf))();\r\n\t\t\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t\t\t\t\tglobalContext.pageBuilder = new BobbleHead.PageBuilder();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else\r\n\t\t\t\t\t\t\tglobalContext.pageBuilder = new BobbleHead.PageBuilder();\r\n\t\t\t\t\t\tglobalContext.pageBuilder.container = hold_conf.container;\r\n\t\t\t\t\t\tvar defaultConnector_conf = (temp_configuration.getElementsByTagName('defaultConnector')[0]);\r\n\t\t\t\t\t\tif(defaultConnector_conf){\r\n\t\t\t\t\t\t\tdefaultConnector_conf = defaultConnector_conf.textContent || 'BobbleHead.GenericConnector';\r\n\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\tglobalContext.defaultConnector = new (BobbleHead.Util.getClassFromName(defaultConnector_conf))();\r\n\t\t\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t\t\t\t\tglobalContext.defaultConnector = new BobbleHead.GenericConnector();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else\r\n\t\t\t\t\t\t\tglobalContext.defaultConnector = new BobbleHead.GenericConnector();\r\n\t\t\t\t\t\tvar accessController_conf = (temp_configuration.getElementsByTagName('accessController')[0]);\r\n\t\t\t\t\t\tvar accesscontroller_promise = null;\r\n\t\t\t\t\t\tif(accessController_conf){\r\n\t\t\t\t\t\t\tvar accessController_conf_name = accessController_conf.textContent || 'BobbleHead.AccessController';\r\n\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\tglobalContext.accessController = new (BobbleHead.Util.getClassFromName(accessController_conf_name))();\r\n\t\t\t\t\t\t\taccesscontroller_promise = globalContext.accessController.init(accessController_conf.getAttribute('method'));\r\n\t\t\t\t\t\t\t}catch(e){\r\n\t\t\t\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t\t\t\t\tglobalContext.accessController = new BobbleHead.AccessController();\r\n\t\t\t\t\t\t\taccesscontroller_promise = globalContext.accessController.init(accessController_conf.getAttribute('method') || 'none')\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tglobalContext.accessController = new BobbleHead.AccessController();\r\n\t\t\t\t\t\t\taccesscontroller_promise = globalContext.accessController.init('none');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tglobalContext.localDatabase = BobbleHead.Database.getInstance();\r\n\t\t\t\t\t\taccesscontroller_promise.then(function(){\r\n\t\t\t\t\t\t\tvar otherPromises = [];\r\n\t\t\t\t\t\t\tfor(var sm of BobbleHead.ModulePool.getModules()){\r\n\t\t\t\t\t\t\t\tvar sandbox = new Sandbox(document.getElementById(hold_conf.container), globalContext.clone());\r\n\t\t\t\t\t\t\t\tvar initReturn = sandbox.execMethod('init', [moduleConfs[sm.name]], sm);\r\n\t\t\t\t\t\t\t\tif(initReturn instanceof Promise)\r\n\t\t\t\t\t\t\t\t\totherPromises.push(initReturn);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif(pages_index){\r\n\t\t\t\t\t\t\t\thold_conf.index = parseInt(pages_index.getAttribute('vid'));\r\n\t\t\t\t\t\t\t\tvar index_data = null;\r\n\t\t\t\t\t\t\t\tif(pages_index.getElementsByTagName('data')[0]){\r\n\t\t\t\t\t\t\t\t\tindex_data = {};\r\n\t\t\t\t\t\t\t\t\tfor(var c of (pages_index.getElementsByTagName('data')[0]).childNodes){\r\n\t\t\t\t\t\t\t\t\t\tif(c instanceof Element)\r\n\t\t\t\t\t\t\t\t\t\t\tindex_data[c.tagName] = c.textContent;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tPromise.all(otherPromises).then(function(index,index_data){\r\n\t\t\t\t\t\t\t\t\tthis.pageBuilder.buildPage(index,index_data);\r\n\t\t\t\t\t\t\t\t}.bind(globalContext,hold_conf.index,index_data));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tthis.initialization = false;\r\n\t\t\t\t\t\t}.bind(this));\r\n\t\t\t\t\t}.bind(this));\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tBobbleHead.log(e);\r\n\t\t\t\t\tthrow new BobbleHead.Errors.NotSupportedEngineError();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tstatic getConf(name){\r\n\t\t\t\tif(BobbleHead.AppController.configuration)\r\n\t\t\t\t\treturn BobbleHead.AppController.configuration.getProperty(name);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t},\r\n\t\tXMLParser: class{\r\n\t\t\tstatic getDOMParser(){\r\n\t\t\t\tif(BobbleHead.XMLParser.domParser == null)\r\n\t\t\t\t\tBobbleHead.XMLParser.domParser = new DOMParser();\r\n\t\t\t\treturn BobbleHead.XMLParser.domParser;\r\n\t\t\t}\r\n\t\t\tstatic parseUrl(url,callback){\r\n\t\t\t\tvar xhttp = new XMLHttpRequest();\r\n\t\t\t\txhttp.open('get', url, true);\r\n\t\t\t\txhttp.responseType = 'text';\r\n\t\t\t\txhttp.onreadystatechange = function(callback){\r\n\t\t\t\t\tif(xhttp.readyState === XMLHttpRequest.DONE){\r\n\t\t\t\t\t\tcallback(this.parseString(xhttp.response));\r\n\t\t\t\t\t}\r\n\t\t\t\t}.bind(this,callback);\r\n\t\t\t\txhttp.send();\r\n\t\t\t}\r\n\t\t\tstatic parseString(txt){\r\n\t\t\t\tvar xmlDoc = null;\r\n\t\t\t\tif (window.DOMParser){\r\n\t\t\t\t\tvar parser = BobbleHead.XMLParser.getDOMParser();\r\n\t\t\t\t\txmlDoc = parser.parseFromString(txt, \"application/xml\");\r\n\t\t\t\t}else{\r\n\t\t\t\t\txmlDoc = new ActiveXObject(\"Microsoft.XMLDOM\");\r\n\t\t\t\t\txmlDoc.async = false;\r\n\t\t\t\t\txmlDoc.loadXML(txt);\r\n\t\t\t\t}\r\n\t\t\t\treturn xmlDoc;\r\n\t\t\t}\r\n\t\t},\r\n\t\tContext: class{\r\n\t\t\tconstructor(properties = {}){\r\n\t\t\t\tfor(var p in properties)\r\n\t\t\t\t\tthis[p] = properties[p];\r\n\t\t\t}\r\n\t\t\tclone(){\r\n\t\t\t\treturn new BobbleHead.Context(this);\r\n\t\t\t}\r\n\t\t\tstatic getGlobal(){\r\n\t\t\t\tif(!BobbleHead.Context.globalContext)\r\n\t\t\t\t\tBobbleHead.Context.globalContext = new BobbleHead.Context();\r\n\t\t\t\treturn BobbleHead.Context.globalContext;\r\n\t\t\t}\r\n\t\t},\r\n\t\tdefaultCallback: function(){\r\n\t\t\tif(arguments.length>0)\r\n\t\t\t\tBobbleHead.log(arguments);\r\n\t\t},\r\n\t\tExceptions: {\r\n\t\t\tFrameworkException: class{\r\n\t\t\t\tconstructor(message){\r\n\t\t\t\t\tthis.name = 'FrameworkException';\r\n\t\t\t\t\tthis.message = message;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tErrors: {\r\n\t\t\tFrameworkError: class{\r\n\t\t\t\tconstructor(message){\r\n\t\t\t\t\tthis.name = 'FrameworkError';\r\n\t\t\t\t\tthis.message = message;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tFrameworkEvent: class extends Event{},\r\n\t\tlog: function(data,level = null,description = null){\r\n\t\t\tif(level!=null && description != null){\r\n\t\t\t\tif(parseInt(level)>1)\r\n\t\t\t\t\t\r\n\t\t\t\t\tconsole.error('['+data+'] ', description);\r\n\t\t\t\telse\r\n\t\t\t\t\tconsole.log('['+data+'] ', description)\r\n\t\t\t}else\r\n\t\t\t\tconsole.log(data);\r\n\t\t},\r\n\t\tUtil: {\r\n\t\t\tisRemoteURIPattern: /^http[s]?:\\/\\//i,\r\n\t\t\tvidInURIPattern: /^([0-9]+|back)\\/?/,\r\n\t\t\tstrInURIPattern: /^([\\w]+)\\/?/,\r\n\t\t\tgetClassFromName: function(str){\r\n\t\t\t\tvar curr = window;\r\n\t\t\t\tvar _clss = str.split('.');\r\n\t\t\t\tfor(var i=0; i<_clss.length; i++){\r\n\t\t\t\t\tcurr = curr[_clss[i]];\r\n\t\t\t\t}\r\n\t\t\t\treturn curr;\r\n\t\t\t},\r\n\t\t\tabsoluteURL: function(base, relative, trailingSlash = true) {\r\n\t\t\t\tvar stack = base.split(\"/\"),\r\n\t\t\t\t\tparts = relative.split(\"/\");\r\n\t\t\t\tif(trailingSlash)\r\n\t\t\t\t\tstack.pop(); // remove current file name (or empty string)\r\n\t\t\t\t\t\t\t\t // (omit if \"base\" is the current folder without trailing slash)\r\n\t\t\t\tfor (var i=0; i<parts.length; i++) {\r\n\t\t\t\t\tif (parts[i] == \".\")\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\tif (parts[i] == \"..\")\r\n\t\t\t\t\t\tstack.pop();\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tstack.push(parts[i]);\r\n\t\t\t\t}\r\n\t\t\t\treturn stack.join(\"/\");\r\n\t\t\t},\r\n\t\t\texecFuncWithArgList: function(f, args) {\r\n\t\t\t\tvar params = [f].concat(args);\r\n\t\t\t\treturn f.bind.apply(f, params);\r\n\t\t\t},\r\n\t\t\tserializeFormData(fd){\r\n\t\t\t\tvar r = [];\r\n\t\t\t\tfor(var x of fd.entries())\r\n\t\t\t\t\tr.push(x[0]+'='+x[1]);\r\n\t\t\t\treturn r.join('&');\r\n\t\t\t},\r\n\t\t\tHeap: class{\r\n\t\t\t\tconstructor(unorderedArray = null){\r\n\t\t\t\t\tif(unorderedArray)\r\n\t\t\t\t\t\tthis.build(unorderedArray);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthis.array = [];\r\n\t\t\t\t}\r\n\t\t\t\tsx(i){\r\n\t\t\t\t\treturn 2*i;\r\n\t\t\t\t}\r\n\t\t\t\tdx(i){\r\n\t\t\t\t\treturn (2*i)+1;\r\n\t\t\t\t}\r\n\t\t\t\tfather(i){\r\n\t\t\t\t\treturn parseInt(i/2);\r\n\t\t\t\t}\r\n\t\t\t\theapify(i){\r\n\t\t\t\t\tvar l = this.sx(i);\r\n\t\t\t\t\tvar r = this.dx(i);\r\n\t\t\t\t\tvar m = i;\r\n\t\t\t\t\tif(l<this.array.length && this.array[l].getKey() > this.array[i].getKey())\r\n\t\t\t\t\t\tm = l;\r\n\t\t\t\t\tif(r<this.array.length && this.array[r].getKey() > this.array[m].getKey())\r\n\t\t\t\t\t\tm = r;\r\n\t\t\t\t\tif(m != i){\r\n\t\t\t\t\t\tvar h = this.array[i];\r\n\t\t\t\t\t\tthis.array[i] = this.array[m];\r\n\t\t\t\t\t\tthis.array[m] = h;\r\n\t\t\t\t\t\tthis.heapify(m);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tbuild(unorderedArray){\r\n\t\t\t\t\tthis.array = unorderedArray;\r\n\t\t\t\t\tthis.reheap();\r\n\t\t\t\t}\r\n\t\t\t\treheap(){\r\n\t\t\t\t\tfor(var i = parseInt(this.array.length/2); i>=0; i--)\r\n\t\t\t\t\t\tthis.heapify(i);\r\n\t\t\t\t}\r\n\t\t\t\taddNode(node){\r\n\t\t\t\t\tthis.array.push(node);\r\n\t\t\t\t\tthis.reheap();\r\n\t\t\t\t}\r\n\t\t\t\tpop(){\r\n\t\t\t\t\tif(this.array.length==0) return null;\r\n\t\t\t\t\tvar r = this.array[0];\r\n\t\t\t\t\tthis.array[0] = this.array[this.array.length - 1];\r\n\t\t\t\t\tthis.array.length = this.array.length - 1;\r\n\t\t\t\t\tthis.heapify(0);\r\n\t\t\t\t\treturn r;\r\n\t\t\t\t}\r\n\t\t\t\tgetFirst(){\r\n\t\t\t\t\tif(this.array.length==0) return null;\r\n\t\t\t\t\treturn this.array[0];\r\n\t\t\t\t}\r\n\t\t\t\tfindByValue(val){\r\n\t\t\t\t\treturn new Promise(function(resolve, reject){\r\n\t\t\t\t\t\tfor(var i=0, l=this.array.length; i<l; i++){\r\n\t\t\t\t\t\t\tvar res = this.array[i].getValue().equal(val);\r\n\t\t\t\t\t\t\tif(res === true)\r\n\t\t\t\t\t\t\t\tresolve(this.array[i]);\r\n\t\t\t\t\t\t\tif(res instanceof Promise)\r\n\t\t\t\t\t\t\t\tres.then(function(ele, callback, negate, result){\r\n\t\t\t\t\t\t\t\t\tif(res === true)\r\n\t\t\t\t\t\t\t\t\t\tcallback(ele);\r\n\t\t\t\t\t\t\t\t\tif(res === false)\r\n\t\t\t\t\t\t\t\t\t\tnegate();\r\n\t\t\t\t\t\t\t\t\tif(res instanceof Array)\r\n\t\t\t\t\t\t\t\t\t\tfor(var i=0; i<res.length; i++)\r\n\t\t\t\t\t\t\t\t\t\t\tif(res[i] === false)\r\n\t\t\t\t\t\t\t\t\t\t\t\tnegate();\r\n\t\t\t\t\t\t\t\t\tcallback(ele);\r\n\t\t\t\t\t\t\t\t}.bind(this, this.array[i], resolve, reject));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treject();\r\n\t\t\t\t\t}.bind(this));\r\n\t\t\t\t}\r\n\t\t\t\t*getNodes(){\r\n\t\t\t\t\tfor(var i=0, l=this.array.length; i<l; i++)\r\n\t\t\t\t\t\tyield this.array[i];\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tHeapNode: class{\r\n\t\t\t\tconstructor(key,value){\r\n\t\t\t\t\tthis.key = key;\r\n\t\t\t\t\tthis.value = value;\r\n\t\t\t\t}\r\n\t\t\t\tgetKey(){\r\n\t\t\t\t\treturn this.key;\r\n\t\t\t\t}\r\n\t\t\t\tincKey(){\r\n\t\t\t\t\tthis.key++;\r\n\t\t\t\t}\r\n\t\t\t\tdecKey(){\r\n\t\t\t\t\tthis.key--;\r\n\t\t\t\t}\r\n\t\t\t\tincreaseKey(i){\r\n\t\t\t\t\tthis.key += i;\r\n\t\t\t\t}\r\n\t\t\t\treduceKey(i){\r\n\t\t\t\t\tthis.key -= i;\r\n\t\t\t\t}\r\n\t\t\t\tgetValue(){\r\n\t\t\t\t\treturn this.value;\r\n\t\t\t\t}\r\n\t\t\t\tsetValue(value){\r\n\t\t\t\t\tthis.value = value;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t//static class attribute\r\n\tBobbleHead.UserPool.users = {};\r\n\tBobbleHead.RolePool.roles = {};\r\n\tBobbleHead.ModelPool.models = {};\r\n\tBobbleHead.ModulePool.modules = {};\r\n\tBobbleHead.Router.routes = [];\r\n\tBobbleHead.InternalConnector.instance = null;\r\n\tBobbleHead.ExternalConnector.instance = null;\r\n\tBobbleHead.Cacher.cacheHeap = null;\r\n\tBobbleHead.Cacher.cacheMap = null;\r\n\tBobbleHead.Cacher.whitelist = null;\r\n\tBobbleHead.Cacher.blacklist = null;\r\n\tBobbleHead.Cacher.maxCached = 1000;\r\n\tBobbleHead.Cacher.nodesPartNum = 3;\r\n\tBobbleHead.Database.instance = null;\r\n\tBobbleHead.XMLParser.domParser = null;\r\n\tBobbleHead.AppController.configuration = null;\r\n\tBobbleHead.Context.globalContext = null;\r\n\tBobbleHead.AuthenticationMethods.methods = {};\r\n\t//Library Sub-class\r\n\tBobbleHead.ConnectorRequest = class extends BobbleHead.Request{\r\n\t\tconstructor(method,uri,data,headers = {}){\r\n\t\t\tsuper(method,uri,data,headers);\t\r\n\t\t}\r\n\t\tgetDataAsObject(){\r\n\t\t\tvar r = null;\r\n\t\t\tif(this.data!=null){\r\n\t\t\t\tr = {};\r\n\t\t\t\tfor(var x of this.data.entries())\r\n\t\t\t\t\tr[x[0]] = x[1];\r\n\t\t\t}\r\n\t\t\treturn r;\r\n\t\t}\r\n\t\tsetData(a,b = null){\r\n\t\t\tif(a == null)\r\n\t\t\t\tthis.data = null;\r\n\t\t\telse\r\n\t\t\t\tif(a instanceof FormData){\r\n\t\t\t\t\tthis.data = a;\r\n\t\t\t\t}else if(b != null && (typeof a === \"string\")){\r\n\t\t\t\t\tif(this.data == null)\r\n\t\t\t\t\t\tthis.data = new FormData();\r\n\t\t\t\t\tthis.data.set(a,b);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfor(var p in a)\r\n\t\t\t\t\t\tthis.setData(p, a[p]);\r\n\t\t\t\t}\r\n\t\t}\r\n\t\tequal(x){\r\n\t\t\tif(!(x instanceof BobbleHead.Request)) return false;\r\n\t\t\tif(this.method != x.getMethod()) return false;\r\n\t\t\tif(this.uri != x.getUri()) return false;\r\n\t\t\tvar xData = x.getData();\r\n\t\t\tvar promises = null;\r\n\t\t\tif(xData != null && this.data != null){\r\n\t\t\t\tvar size = 0;\r\n\t\t\t\tif(x instanceof BobbleHead.ConnectorRequest){\r\n\t\t\t\t\tvar xsize = 0;\r\n\t\t\t\t\tfor(var k of xData.keys())\r\n\t\t\t\t\t\txsize++;\r\n\t\t\t\t\tif(xsize != size) return false;\r\n\t\t\t\t\tfor(var i of this.data){\r\n\t\t\t\t\t\tif(xData.get(i[0]) != i[1]) return false;\r\n\t\t\t\t\t\tsize++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(x instanceof BobbleHead.CacherRequest){\r\n\t\t\t\t\tfor(var i of this.data){\r\n\t\t\t\t\t\tif(i[1] instanceof Blob){\r\n\t\t\t\t\t\t\tpromises.push(new Promise(function(resolve, reject){\r\n\t\t\t\t\t\t\t\tvar reader = new FileReader();\r\n\t\t\t\t\t\t\t\treader.onload = function(){\r\n\t\t\t\t\t\t\t\t\tresolve(xData[i[0]] == md5(reader.result));\r\n\t\t\t\t\t\t\t\t}.bind(this);\r\n\t\t\t\t\t\t\t\treader.readAsText(i[1]);\r\n\t\t\t\t\t\t\t}));\r\n\t\t\t\t\t\t}else if(xData[i[0]] != i[1]) return false;\r\n\t\t\t\t\t\tsize++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(Object.keys(xData).length != size) return false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if(xData !== this.data) return false;\r\n\t\t\treturn !promises ? true : Promise.all(promises);\r\n\t\t}\r\n\t\ttoCacherRequest(){\r\n\t\t\treturn new BobbleHead.CacherRequest(this.method,this.uri,this.data,this.headers);\r\n\t\t}\r\n\t};\r\n\tBobbleHead.CacherRequest = class extends BobbleHead.Request{\r\n\t\tconstructor(method,uri,data,headers = {}){\r\n\t\t\tsuper(method,uri,data,headers);\r\n\t\t\tvar promises = this.promise;\r\n\t\t\tdelete this.promise;\r\n\t\t\treturn promises || this;\r\n\t\t}\r\n\t\tsetData(a,b = null){\r\n\t\t\tthis.promise = null;\r\n\t\t\tif(a instanceof FormData){\r\n\t\t\t\tthis.data = {};\r\n\t\t\t\tfor(var x of a.entries())\r\n\t\t\t\t\tif(x[1] instanceof Blob){\r\n\t\t\t\t\t\tif(this.promise == null)\r\n\t\t\t\t\t\t\tthis.promise = [];\r\n\t\t\t\t\t\tthis.promise.push(new Promise(function(name, resolve, reject){\r\n\t\t\t\t\t\t\tvar reader = new FileReader();\r\n\t\t\t\t\t\t\treader.onload = function(){\r\n\t\t\t\t\t\t\t\tthis.data[name] = md5(reader.result);\r\n\t\t\t\t\t\t\t\tresolve(this);\r\n\t\t\t\t\t\t\t}.bind(this);\r\n\t\t\t\t\t\t\treader.readAsText(x[1]);\r\n\t\t\t\t\t\t}.bind(this, x[0])));\r\n\t\t\t\t\t}else\r\n\t\t\t\t\t\tthis.data[x[0]] = x[1];\r\n\t\t\t}else if(b != null && (typeof a === \"string\")){\r\n\t\t\t\tif(this.data == null)\r\n\t\t\t\t\tthis.data = {};\r\n\t\t\t\tthis.data[a] = b;\r\n\t\t\t}else\r\n\t\t\t\tthis.data = a;\r\n\t\t}\r\n\t\ttoRequest(){\r\n\t\t\tvar toData = null;\r\n\t\t\tif(this.data != null){\r\n\t\t\t\ttoData = new FormData();\r\n\t\t\t\tfor(var x in this.data)\r\n\t\t\t\t\ttoData.append(x, this.data[x]);\r\n\t\t\t}\r\n\t\t\treturn new BobbleHead.ConnectorRequest(this.method,this.uri,toData,this.headers);\r\n\t\t}\r\n\t\tstatic fromObject(obj){\r\n\t\t\tif(('method' in obj) && ('uri' in obj) && ('data' in obj))\r\n\t\t\t\treturn new BobbleHead.CacherRequest(obj.method,obj.uri,obj.data,obj.headers || undefined);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tequal(x){\r\n\t\t\tif(!(x instanceof BobbleHead.Request)) return false;\r\n\t\t\tif(this.method != x.getMethod()) return false;\r\n\t\t\tif(this.uri != x.getUri()) return false;\r\n\t\t\tvar xData = x.getData();\r\n\t\t\tvar promises = null;\r\n\t\t\tif(xData != null && this.data != null)\r\n\t\t\t\tif(x instanceof BobbleHead.ConnectorRequest){\r\n\t\t\t\t\tvar size = Object.keys(this.data).length;\r\n\t\t\t\t\tvar xsize = 0;\r\n\t\t\t\t\tfor(var i of xData){\r\n\t\t\t\t\t\tif(i[1] instanceof Blob){\r\n\t\t\t\t\t\t\tpromises.push(new Promise(function(resolve, reject){\r\n\t\t\t\t\t\t\t\tvar reader = new FileReader();\r\n\t\t\t\t\t\t\t\treader.onload = function(){\r\n\t\t\t\t\t\t\t\t\tresolve(this.data[i[0]] == md5(reader.result));\r\n\t\t\t\t\t\t\t\t}.bind(this);\r\n\t\t\t\t\t\t\t\treader.readAsText(i[1]);\r\n\t\t\t\t\t\t\t}.bind(this)));\r\n\t\t\t\t\t\t}else if(this.data[i[0]] != i[1]) return false;\r\n\t\t\t\t\t\txsize++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(xsize != size) return false;\r\n\t\t\t\t}else if(x instanceof BobbleHead.CacherRequest){\r\n\t\t\t\t\tif(Object.keys(xData).length != Object.keys(this.data).length) return false;\r\n\t\t\t\t\tfor(var i in this.data)\r\n\t\t\t\t\t\tif(xData[i] != this.data[i]) return false;\r\n\t\t\t\t}\r\n\t\t\telse if(xData !== this.data) return false;\r\n\t\t\treturn !promises ? true : Promise.all(promises);\r\n\t\t}\r\n\t};\r\n\tBobbleHead.ModuleConfiguration = class extends BobbleHead.GenericConfiguration{};\r\n\tBobbleHead.PageConfiguration = class extends BobbleHead.GenericConfiguration{};\r\n\tBobbleHead.Util.ReverseHeap = class extends BobbleHead.Util.Heap {\r\n\t\theapify(i){\r\n\t\t\tvar l = this.sx(i);\r\n\t\t\tvar r = this.dx(i);\r\n\t\t\tvar m = i;\r\n\t\t\tif(l<this.array.length && this.array[l].getKey() < this.array[i].getKey())\r\n\t\t\t\tm = l;\r\n\t\t\tif(r<this.array.length && this.array[r].getKey() < this.array[m].getKey())\r\n\t\t\t\tm = r;\r\n\t\t\tif(m != i){\r\n\t\t\t\tvar h = this.array[i];\r\n\t\t\t\tthis.array[i] = this.array[m];\r\n\t\t\t\tthis.array[m] = h;\r\n\t\t\t\tthis.heapify(m);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\tBobbleHead.AuthenticationMethods.NoneAuthentication = class extends BobbleHead.AuthenticationMethod{};\r\n\tBobbleHead.AuthenticationMethods.addMethod('none',BobbleHead.AuthenticationMethods.NoneAuthentication);\r\n\tBobbleHead.AuthenticationMethods.BasicAuthentication = class extends BobbleHead.AuthenticationMethod{\r\n\t\tlogin(data = null){\r\n\t\t\tif(data.name && data.password){\r\n\t\t\t\tvar user = new BobbleHead.User(data.name, data.password, ['user']);\r\n\t\t\t\tthis.session = new BobbleHead.Session({'user': user});\r\n\t\t\t}else\r\n\t\t\t\tBobbleHead.log('BasicAuthentication',1,'Invalid user');\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tlogout(){\r\n\t\t\tthis.replaceCurrentSession(null);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tprocessRequest(request = null){\r\n\t\t\tif(request){\r\n\t\t\t\tif(this.session){\r\n\t\t\t\t\tvar userInfo = this.session.getInfo();\r\n\t\t\t\t\tvar userObj = userInfo.user;\r\n\t\t\t\t\trequest.setHeader('Authorization','Basic ' + btoa(userObj.name+':'+userObj.password));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tprocessPage(page = null){\r\n\t\t\tif(page && page.roles){\r\n\t\t\t\tif(this.session){\r\n\t\t\t\t\tvar userInfo = this.session.getInfo();\r\n\t\t\t\t\tvar userObj = userInfo.user;\r\n\t\t\t\t\tvar flag = false;\r\n\t\t\t\t\tfor(var i=0; i<page.roles.length; i++){\r\n\t\t\t\t\t\tif(userObj.roles.indexOf(page.roles[i])!=-1)\r\n\t\t\t\t\t\t\tflag = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!flag){\r\n\t\t\t\t\t\tthrow new BobbleHead.Exceptions.UnauthorizedException();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(page.roles.length>0)\r\n\t\t\t\t\tthrow new BobbleHead.Exceptions.UnauthorizedException();\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\tBobbleHead.AuthenticationMethods.addMethod('basic',BobbleHead.AuthenticationMethods.BasicAuthentication);\r\n\t//Exception\r\n\tBobbleHead.Exceptions.PageNotFoundException = class extends BobbleHead.Exceptions.FrameworkException{};\r\n\tBobbleHead.Exceptions.RedirectException = class extends BobbleHead.Exceptions.FrameworkException{\r\n\t\tconstructor(vid, data = null){\r\n\t\t\tsuper();\r\n\t\t\tthis.vid = vid;\r\n\t\t\tthis.data = data;\r\n\t\t}\r\n\t};\r\n\tBobbleHead.Exceptions.NotSupportedException = class extends BobbleHead.Exceptions.FrameworkException{};\r\n\tBobbleHead.Exceptions.UnauthorizedException = class extends BobbleHead.Exceptions.FrameworkException{};\r\n\tBobbleHead.Exceptions.InvalidRouteException = class extends BobbleHead.Exceptions.FrameworkException{};\r\n\tBobbleHead.Exceptions.ControllerNotFoundException = class extends BobbleHead.Exceptions.FrameworkException{};\r\n\tBobbleHead.Exceptions.InvalidAuthenticationMethodException = class extends BobbleHead.Exceptions.FrameworkException{};\r\n\tBobbleHead.Errors.NotSupportedEngineError = class extends BobbleHead.Errors.FrameworkError{\r\n\t\tconstructor(){\r\n\t\t\tsuper('Current Javascript Engine doesn\\'t support the framework.');\r\n\t\t}\r\n\t};\r\n\t//Events\r\n\tBobbleHead.CacherLoadedEvent = class extends BobbleHead.FrameworkEvent{\r\n\t\tconstructor(data = null){\r\n\t\t\tsuper('cacherloaded', data);\r\n\t\t}\r\n\t};\r\n\tBobbleHead.AccessControllerLoadedEvent = class extends BobbleHead.FrameworkEvent{\r\n\t\tconstructor(data = null){\r\n\t\t\tsuper('acloaded', data);\r\n\t\t}\r\n\t};\r\n\tBobbleHead.PageReadyEvent = class extends BobbleHead.FrameworkEvent{\r\n\t\tconstructor(data = null){\r\n\t\t\tsuper('pageready', data);\r\n\t\t}\r\n\t};\r\n\t//Main Routine\r\n\treturn new BobbleHead.AppController('./app.xml');\r\n\r\n})(window);\r\n\n\n//# sourceURL=webpack:///./src/bobblehead.js?");

/***/ })

/******/ });